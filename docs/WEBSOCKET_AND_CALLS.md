# WebSocket и звонки — что сделано и что можно улучшить

## Что уже сделано

### Сообщения
- **Гарантированная доставка**: при отсутствии ключа E2EE у собеседника сообщения всегда отправляются без шифрования — сообщения не блокируются.
- **Ошибка отправки**: при «WebSocket не подключен» показывается диалог с текстом «Нет соединения с сервером. Проверьте интернет и обновите страницу».
- **Ошибки от сервера**: при событии `error` от сокета (например, валидация) показывается диалог с текстом ошибки.

### WebSocket
- **Автопереподключение**: при обрыве соединения (сеть, перезапуск сервера) выполняется переподключение с экспоненциальной задержкой (до 15 с).
- **Статус соединения**: `connectionStatus` — `connected` / `disconnected` / `reconnecting`; при `reconnecting` или `disconnected` показывается баннер с кнопкой «Обновить страницу».
- **Повторный join чата**: при переходе в `connected` страница чата снова вызывает `joinChat(chatId)` и подписывается на события, чтобы после переподключения сообщения снова приходили в реальном времени.
- **Транспорты**: добавлен fallback `polling` к `websocket` для обхода части прокси/файрволов.

### Звонки
- **Таймаут**: через ~28 с показывается «Не удалось подключиться» и кнопка «Закрыть».
- **Диалог при ошибке**: текст про возможные причины (собеседник не ответил, сеть, файрвол) и совет обновить страницу.

---

## Что можно улучшить (предложения)

### WebSocket
1. **Heartbeat (ping/pong)**  
   На сервере периодически слать ping, на клиенте отвечать pong — чтобы быстрее обнаруживать «мёртвые» соединения и переподключаться.

2. **Очередь сообщений при отключении**  
   Пока `connectionStatus === 'disconnected'`, сохранять отправляемые сообщения в очередь и отправлять их после переподключения (с предупреждением «Сообщение будет отправлено после восстановления связи»).

3. **Nginx/прокси**  
   Убедиться, что для WebSocket включены таймауты и upgrade:
   ```nginx
   proxy_read_timeout 86400;
   proxy_send_timeout 86400;
   proxy_http_version 1.1;
   proxy_set_header Upgrade $http_upgrade;
   proxy_set_header Connection "upgrade";
   ```

4. **Redis adapter**  
   Если несколько инстансов backend — использовать Redis adapter для Socket.IO, чтобы события доходили до всех инстансов.

### Звонки (WebRTC)
1. **TURN-сервер**  
   За NAT/строгим файрволом часто нужен TURN. Добавить в `webrtc.service.ts` TURN (например, coturn или облачный TURN) в `iceServers`.

2. **Таймаут «нет ответа»**  
   Если собеседник не отвечает на звонок за N секунд — автоматически завершать и показывать диалог «Собеседник не ответил».

3. **Проверка медиа-доступов**  
   Перед инициацией звонка вызывать `getUserMedia` и при отказе/ошибке показывать диалог с понятным текстом (нет микрофона/камеры или доступ запрещён).

### Предупреждение «Публичный ключ другого пользователя не найден»
В коде frontend-web это сообщение **нигде не выводится**. Оно может появляться из:
- старой закэшированной сборки (сделать жёсткое обновление Ctrl+F5);
- расширения браузера.

Шифрование при отсутствии ключа у собеседника отключается, сообщения уходят без E2EE — отправка не блокируется.
