# Обновление кода на сервере — почему не сохраняется

После того как вы обновили код на сервере, изменения могут не отображаться по трём причинам.

---

## Обязательный порядок при каждом изменении

**Чтобы обновления всегда применялись на сервере в одном и том же порядке**, используйте скрипты:

### Вариант A: Всё одной командой (локально)

Синхронизация кода на сервер + сборка фронта и бэка + перезапуск PM2 + перезагрузка Nginx:

- **Linux / Mac / Git Bash:**  
  `bash scripts/deploy-update.sh`
- **Windows (PowerShell):**  
  `.\scripts\deploy-update.ps1`

При необходимости задайте сервер и путь:
- `DEPLOY_SERVER=root@89.169.39.244 DEPLOY_PATH=/var/www/messager bash scripts/deploy-update.sh`

### Вариант B: Код уже на сервере (git pull / копирование вручную)

Зайдите на сервер и выполните **обязательный порядок** одной командой:

```bash
cd /var/www/messager && bash scripts/update-on-server.sh
```

Скрипт по шагам:
1. Сборка фронтенда (`frontend-web` → `dist/`)
2. Сборка бэкенда (`backend` → `dist/`)
3. Перезапуск PM2 (`messager-backend`)
4. Перезагрузка Nginx

---

## 1. Фронтенд (сайт) — нужна новая сборка

Сервер отдаёт уже собранные файлы из папки `frontend-web/dist`. Если вы просто скопировали исходники (`src/`), новая версия не попадёт на сайт.

**Что сделать:**

1. **Локально** (на своём компьютере):
   ```bash
   cd frontend-web
   npm run build
   ```
2. Скопировать **содержимое папки** `frontend-web/dist` на сервер в `/var/www/messager/frontend-web/dist` (полностью заменить старые файлы).
3. В браузере сделать **жёсткое обновление**: `Ctrl+Shift+R` (Windows/Linux) или `Cmd+Shift+R` (Mac), либо открыть сайт в режиме инкогнито.

---

## 2. Бэкенд (API) — нужен перезапуск

Если меняли код в папке `backend/`, сервер должен снова собрать проект и перезапустить процесс.

**На сервере:**

```bash
cd /var/www/messager/backend
npm run build
pm2 restart messager-backend
```

Проверить, что процесс запущен:

```bash
pm2 list
pm2 logs messager-backend --lines 20
```

---

## 3. Nginx — кэш index.html

В конфиг добавлено правило: **index.html не кэшируется**. После обновления `dist/` и перезагрузки nginx браузер будет каждый раз забирать свежий `index.html` и подхватывать новые JS/CSS.

**На сервере после правок nginx:**

```bash
sudo nginx -t
sudo systemctl reload nginx
```

(Если конфиг лежит в другом месте — перезагрузить nginx так, как вы обычно это делаете.)

---

## Краткий чеклист после обновления кода

**Рекомендуется:** при каждом изменении запускать один скрипт — тогда порядок всегда один и тот же.

| Как обновлять | Команда |
|---------------|--------|
| **Локально (всё сразу)** | `bash scripts/deploy-update.sh` или `.\scripts\deploy-update.ps1` |
| **На сервере (код уже скопирован)** | `cd /var/www/messager && bash scripts/update-on-server.sh` |

Ручной порядок (если скрипты не используете):

| Что меняли      | Действие |
|-----------------|----------|
| Фронтенд (React)| Локально: `npm run build` в `frontend-web` → скопировать `dist/` на сервер → в браузере Ctrl+Shift+R |
| Бэкенд (NestJS) | На сервере: `cd backend` → `npm run build` → `pm2 restart messager-backend` |
| Nginx           | На сервере: `sudo nginx -t` → `sudo systemctl reload nginx` |

После этого обновления должны «сохраняться» и отображаться на сайте.
