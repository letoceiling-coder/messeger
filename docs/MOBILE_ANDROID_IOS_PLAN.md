# План разработки Android и iOS приложений Messager

Документ описывает последовательный план создания нативных приложений Android и iOS на базе существующего мобильного проекта (Expo/React Native), с поддержкой обновлений, фонового режима, push-уведомлений, звонков и настраиваемых звуков.

---

## 1. Требования (чеклист)

- [x] Приложения Android и iOS на основе текущего проекта
- [x] Возможность обновления приложений при обновлении кода (OTA + магазины)
- [x] Работа в фоновом режиме и уведомления о сообщениях
- [x] Уведомления о входящих звонках/видеозвонках (мелодия звонка)
- [x] Звуковые уведомления и всплывающие окна (диалоги)
- [x] Настройки: вкл/выкл уведомлений, беззвучно, вибро, громкость, выбор мелодии
- [x] Звуки по умолчанию для сообщений и для вызова/видеовызова
- [x] Ссылки для установки (Android / iOS)
- [x] Правильная структура проектов Android и iOS
- [x] **Обязательно:** единый визуальный вид и одинаковая функциональность с веб-версией (см. раздел 9 и [PLAN_MESSENGER_IMPROVEMENTS.md](./PLAN_MESSENGER_IMPROVEMENTS.md), этап 14)

---

## 2. Целевая структура приложений

### 2.1 Общая структура (Expo / React Native)

```
mobile/
├── app.json                    # Конфиг Expo (версия, имя, плагины)
├── app.config.js               # Динамический конфиг (env, EAS)
├── eas.json                    # EAS Build & Update
├── package.json
├── App.tsx
├── assets/
│   ├── icon.png
│   ├── adaptive-icon.png
│   ├── splash.png
│   ├── sounds/
│   │   ├── message-default.mp3   # Уведомление о сообщении (по умолчанию)
│   │   ├── call-default.mp3      # Мелодия звонка (по умолчанию)
│   │   └── (доп. мелодии по желанию)
│   └── ...
├── src/
│   ├── components/
│   ├── contexts/
│   │   ├── AuthContext.tsx
│   │   ├── WebSocketContext.tsx
│   │   ├── NotificationContext.tsx   # Уведомления + настройки
│   │   └── SettingsContext.tsx       # Настройки приложения
│   ├── screens/
│   │   ├── LoginScreen.tsx
│   │   ├── ChatsScreen.tsx
│   │   ├── ChatScreen.tsx
│   │   ├── SettingsScreen.tsx        # Экран настроек
│   │   └── NotificationSettingsScreen.tsx  # Подэкран: уведомления
│   ├── services/
│   │   ├── api.ts
│   │   ├── websocket.service.ts
│   │   ├── push.service.ts           # Expo Push + регистрация токена на бэкенде
│   │   ├── notifications.service.ts # Локальные уведомления + звуки
│   │   └── settings.service.ts       # Хранение настроек (AsyncStorage)
│   ├── hooks/
│   │   ├── useNotifications.ts
│   │   └── useBackgroundTask.ts
│   ├── types/
│   └── constants/
│       └── defaultSounds.ts
└── ...
```

### 2.2 Нативные части (генерируются Expo)

- **Android**: `android/` (при `expo prebuild` или EAS Build) — пакет `com.messager.app`, разрешения для уведомлений, фона, звука.
- **iOS**: `ios/` — Bundle ID `com.messager.app`, Capabilities: Push Notifications, Background Modes (audio, fetch, remote notifications).

Сборка через **EAS Build** не требует хранить `android/` и `ios/` в репозитории (Expo генерирует их в облаке). Для «bare» workflow можно добавить `expo prebuild` и править нативные файлы при необходимости.

---

## 3. Последовательный план задач (мелкие шаги)

### Фаза 0: Подготовка окружения и конфигурации

| №  | Задача | Описание |
|----|--------|----------|
| 0.1 | EAS CLI и аккаунт Expo | Установить `eas-cli`, войти в Expo account (`eas login`). |
| 0.2 | Создать `eas.json` | Профили: `development`, `preview`, `production` для build и update. |
| 0.3 | Обновить `app.json` / `app.config.js` | Версия, `versionCode`/`buildNumber`, плагины: `expo-notifications`, `expo-updates`, при необходимости `expo-av` для воспроизведения звуков. |
| 0.4 | Настроить каналы уведомлений (Android) | В `app.json` плагин `expo-notifications` с `defaultChannelId` для сообщений и отдельным каналом для звонков (важно для звука/вибро). |
| 0.5 | iOS: Capabilities | В конфиге указать Background Modes (Remote notifications, Audio), Push Notifications. Для EAS Build это задаётся через `app.json`/плагины. |

### Фаза 1: Обновление приложений (OTA + магазины)

| №  | Задача | Описание |
|----|--------|----------|
| 1.1 | Подключить expo-updates | Добавить зависимость `expo-updates`, настроить в `app.config.js` каналы (например, `production`). |
| 1.2 | Настроить EAS Update | В EAS создать проект, привязать к нему приложение; в `eas.json` указать канал для `production` build. |
| 1.3 | Документировать процесс обновления | Как выпускать OTA: `eas update --branch production` после изменений кода; когда нужна новая сборка в магазин (изменение нативного кода/версии). |
| 1.4 | Версионирование | Правило: при изменении только JS/ресурсов — OTA; при изменении `app.json` (version/build), нативных модулей — новая сборка и отправка в магазины. |

### Фаза 2: Backend — Push-уведомления

| №  | Задача | Описание |
|----|--------|----------|
| 2.1 | Модель/таблица устройств | Добавить модель `Device` (или поля в `User`): `userId`, `expoPushToken`, `platform` (ios/android), `updatedAt`. Миграция Prisma. |
| 2.2 | API регистрации токена | Endpoint `POST /devices` или `PUT /users/me/device` с телом `{ expoPushToken, platform }`; сохранять/обновлять токен для текущего пользователя. |
| 2.3 | Отправка push через Expo | Сервис на бэкенде: при событии «новое сообщение» / «входящий звонок» — для получателя взять Expo Push Token и отправить запрос на `https://exp.host/--/api/v2/push/send` (документация Expo Push API). |
| 2.4 | Интеграция в WebSocket | При `message:received` — если получатель не в сети (или дополнительно всегда) — отправить push. При `call:offer` — отправить push «Входящий звонок» с высоким приоритетом. |
| 2.5 | Payload уведомлений | Стандартизировать `data`: `type: 'message' | 'call'`, `chatId`, `messageId` (для сообщений), `callerId` и т.д., чтобы приложение могло открыть нужный экран. |

### Фаза 3: Мобильное приложение — Push и разрешения

| №  | Задача | Описание |
|----|--------|----------|
| 3.1 | Установить expo-notifications и expo-device | Зависимости, в `app.json` плагин с нужными разрешениями. |
| 3.2 | Запрос разрешений | При входе пользователя (после логина) запрашивать разрешение на уведомления (iOS/Android); обрабатывать отказ. |
| 3.3 | Получение Expo Push Token | После разрешения — `getExpoPushTokenAsync()` (с `projectId` из `app.config.js`); сохранять в AsyncStorage и отправлять на бэкенд (API из 2.2). |
| 3.4 | Сервис `push.service.ts` | Регистрация токена, отправка на API, обновление токена при смене (например, при каждом запуске). |
| 3.5 | Обработка входящих push | `addNotificationResponseReceivedListener` / `addNotificationReceivedListener` — по `data.type` открывать чат или экран звонка; воспроизводить звук звонка для `call`. |

### Фаза 4: Локальные уведомления и звуки (в приложении)

| №  | Задача | Описание |
|----|--------|----------|
| 4.1 | Логика показа при открытом приложении | Подписаться на `message:received` по WebSocket (уже есть в приложении). При событии — если приложение на переднем плане и чат не открыт (или открыт другой) — показывать локальное уведомление (или in-app toast) и воспроизводить звук сообщения согласно настройкам. |
| 4.2 | Сервис уведомлений `notifications.service.ts` | Единая точка: воспроизведение звука (expo-av или нативный модуль), вибрация, показ локального уведомления (scheduleNotificationAsync). Учитывать настройки: вкл/выкл, беззвучно, только вибро, громкость, выбранная мелодия. |
| 4.3 | Звуки по умолчанию | Добавить в проект файлы `message-default.mp3` и `call-default.mp3` в `assets/sounds/`; в настройках по умолчанию использовать их. |
| 4.4 | Входящий звонок по WebSocket | Подписаться на `call:offer` в `websocket.service` (или в корневом компоненте). При `call:offer` — воспроизводить мелодию звонка в цикле до ответа/отклонения/таймаута; показывать полноэкранное или модальное окно «Входящий вызов» с кнопками Принять/Отклонить. |
| 4.5 | Вибрация | Использовать API вибрации (Expo / React Native) при уведомлении и звонке, если в настройках включено. |

### Фаза 5: Настройки приложения

| №  | Задача | Описание |
|----|--------|----------|
| 5.1 | Модель настроек | Определить структуру: уведомления вкл/выкл, беззвучный режим (только вибро), громкость уведомлений (0–1), громкость звонка, выбор мелодии сообщения (id/имя файла), выбор мелодии звонка. Хранить в AsyncStorage. |
| 5.2 | `SettingsContext` или `settings.service` | Загрузка/сохранение настроек, значения по умолчанию (звуки из `defaultSounds.ts`). |
| 5.3 | Экран «Настройки» | Корневой экран настроек: пункты «Уведомления», «Профиль», «О приложении» и т.д. |
| 5.4 | Экран «Уведомления» | Переключатели: уведомления вкл/выкл; беззвучно (только вибро); вибро вкл/выкл; слайдер громкости уведомлений; слайдер громкости звонка; выбор мелодии сообщения (список); выбор мелодии звонка (список). Предпросмотр звука при выборе. |
| 5.5 | Применение настроек в реальном времени | При смене громкости/мелодии — сразу использовать в `notifications.service` при следующем событии. |

### Фаза 6: Фоновый режим

| №  | Задача | Описание |
|----|--------|----------|
| 6.1 | Background mode (документация) | Для получения push в фоне достаточно корректно настроить разрешения и Expo Push; ОС доставит уведомление. Для воспроизведения звука звонка в фоне на iOS может понадобиться Background Modes → Audio. |
| 6.2 | Задачи в фоне (опционально) | Если нужна периодическая синхронизация — `expo-background-fetch` + `expo-task-manager`; зарегистрировать задачу и минимальный интервал. |
| 6.3 | Поддержание соединения (ограничения) | В фоне ОС может разрывать WebSocket; полагаться на push для офлайн-доставки, при открытии приложения — переподключение WebSocket. |

### Фаза 7: Сборки и ссылки для установки

| №  | Задача | Описание |
|----|--------|----------|
| 7.1 | Android: подписание | Настроить keystore в EAS (или загрузить свой); в `eas.json` указать credentials для production. |
| 7.2 | iOS: сертификаты и профили | В EAS настроить Apple Developer account, App Store Connect; генерация сертификатов и provisioning profile для push. |
| 7.3 | Сборка AAB (Android) | `eas build --platform android --profile production`; загрузить AAB в Google Play Console (internal/closed/open testing). |
| 7.4 | Сборка IPA (iOS) | `eas build --platform ios --profile production`; загрузить в App Store Connect (TestFlight или на проверку). |
| 7.5 | Ссылки для установки | Android: ссылка на страницу приложения в Google Play (или внутренняя ссылка на APK/AAB для тестов). iOS: ссылка на App Store (или TestFlight). Документировать в README или отдельном файле `INSTALL_LINKS.md`. |
| 7.6 | QR-коды / универсальные ссылки | Для внутреннего тестирования — ссылка на EAS Build artifact (скачивание APK для Android); для iOS — TestFlight link. |

### Фаза 8: Финализация и проверка

| №  | Задача | Описание |
|----|--------|----------|
| 8.1 | Проверка сценариев | Сообщение при закрытом приложении → push → открытие чата. Сообщение при открытом приложении → звук/всплывающее уведомление. Входящий звонок → мелодия + экран ответа. Настройки: отключение звука, только вибро, смена мелодии. |
| 8.2 | Обработка ошибок | Нет сети, отзыв разрешений, истёкший токен — не падать, показывать понятные сообщения. |
| 8.3 | Документация | README в `mobile/` с шагами запуска, EAS Build, EAS Update, настройка push на бэкенде; ссылка на общий план (этот документ). |

---

## 4. Соответствие требованиям

| Требование | Покрытие в плане |
|------------|------------------|
| Android и iOS приложения | Фаза 0 (конфиг), Фаза 7 (сборки); один код на React Native/Expo. |
| Обновление при обновлении кода | Фаза 1 (OTA через EAS Update + обновления через магазины). |
| Фоновый режим и уведомления о сообщениях | Фаза 2 (push с бэкенда), Фаза 3 (приём push), Фаза 6 (фон). |
| Мелодия звонка / видеозвонка | Фаза 2 (push «звонок»), Фаза 4 (звук и экран входящего вызова). |
| Звуковые уведомления и всплывающие окна | Фаза 4 (звук + локальные уведомления / in-app), Фаза 5 (настройки). |
| Настройки: вкл/выкл, беззвучно, вибро, громкость, выбор мелодии | Фаза 5 (экран настроек уведомлений, дефолты в 4.3). |
| Звуки по умолчанию для сообщений и звонков | Фаза 4.3, Фаза 5.1 (defaultSounds). |
| Ссылки для установки Android / iOS | Фаза 7.5–7.6. |
| Правильная структура Android / iOS | Раздел 2 (структура проекта и нативные части). |

---

## 5. Зависимости между фазами

- Фаза 1 (обновления) может идти параллельно с остальными после Фазы 0.
- Фаза 2 (backend push) должна быть готова до полноценного теста push на устройстве (Фаза 3).
- Фаза 3 (push в приложении) и Фаза 4 (звуки и локальные уведомления) логически связаны: сначала разрешения и токен (3), затем единая логика показа и звуков (4).
- Фаза 5 (настройки) использует сервис из Фазы 4.
- Фаза 6 опирается на настройки из Фазы 0 (Background Modes) и Фазы 3 (push).
- Фаза 7 выполняется после стабилизации фич (можно собирать preview-сборки раньше для тестов).

---

## 6. Риски и замечания

- **iOS**: воспроизведение звука в фоне требует Background Modes → Audio и соблюдения правил Apple (например, для VoIP/звонков).
- **Android**: каналы уведомлений обязательны (Android 8+); отдельный канал для звонков с высоким приоритетом улучшит доставку.
- **Expo Push**: бесплатный лимит; при росте нагрузки может понадобиться свой FCM/APNs или платный план.
- **Магазины**: для публичных ссылок нужны аккаунты Google Play и Apple Developer (платные).

План можно использовать как чеклист: отмечать выполненные задачи и при необходимости разбивать пункты на ещё более мелкие подзадачи в трекере (например, в Issues или в отдельном файле статуса).

---

## 7. Шаблон ссылок для установки

Создать в корне репозитория или в `mobile/` файл **`INSTALL_LINKS.md`** (или `INSTALL.md`) со ссылками:

```markdown
# Установка приложения Messager

## Android
- **Google Play**: https://play.google.com/store/apps/details?id=com.messager.app
- Для тестирования (EAS): после сборки `eas build --platform android` ссылка на скачивание будет в панели EAS.

## iOS
- **App Store**: https://apps.apple.com/app/messager/idXXXXXXXXX
- **TestFlight**: https://testflight.apple.com/join/XXXXXX
```

После публикации в магазинах подставить реальные URL.

---

## 8. Константы звуков по умолчанию

В `src/constants/defaultSounds.ts`:

- `MESSAGE_SOUND_DEFAULT`: путь к `assets/sounds/message-default.mp3`
- `CALL_RINGTONE_DEFAULT`: путь к `assets/sounds/call-default.mp3`
- Список доступных мелодий для выбора в настройках (id, label, path).

---

## 9. Приведение к единому формату с веб-версией (обязательно)

**После реализации мобильных приложений и веб-версии обязательно привести все клиенты к единому визуальному виду и одинаковой функциональности.** Детали — в [PLAN_MESSENGER_IMPROVEMENTS.md](./PLAN_MESSENGER_IMPROVEMENTS.md), **Этап 14**. Кратко:

### 9.1 Визуальное единство

- [ ] Использовать те же цвета, размеры шрифтов, скругления и отступы, что и в веб-версии (токены из этапа 0 плана: фон, акцент, текст, вторичный текст).
- [ ] Иконки — те же или из одного набора; расположение элементов (шапка, список чатов, панель ввода) совпадает с веб-версией.
- [ ] Экраны входа, списка чатов, чата и настроек визуально соответствуют страницам веб-версии.

### 9.2 Функциональное единство

- [ ] Все функции веб-версии (вход/регистрация, список чатов, поиск, новый чат, текст/медиа/голос, ответ/пересылка/удаление, звонки, настройки) реализованы в мобильных приложениях, кроме технически невозможного на платформе.
- [ ] При добавлении новой фичи в веб — добавить её и в приложения (и наоборот). Вести чеклист функций и сверять его при каждом релизе.

### 9.3 Порядок выполнения

Этап «единый формат» выполняется **последним**, после всех фаз мобильного плана (0–8) и после этапов 0–13 плана веб-версии. См. **Этап 14** в PLAN_MESSENGER_IMPROVEMENTS.md.
