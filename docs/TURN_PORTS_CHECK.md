# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤ TURN (–ø–æ—á–µ–º—É –∑–≤–æ–Ω–∫–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç)

## –ß—Ç–æ —Å–µ–π—á–∞—Å

- **coturn** —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ VPS, —Å–ª—É—à–∞–µ—Ç 3478 (UDP –∏ TCP).
- **ufw** –≤—ã–∫–ª—é—á–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ –ø–æ—Ä—Ç—ã –Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è).
- **–õ–æ–≥–∏ coturn** –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (—Å–µ—Å—Å–∏–∏ —Å `turn_fdf8b6e8`), –Ω–æ –º–Ω–æ–≥–æ "allocation timeout" ‚Äî –∑–Ω–∞—á–∏—Ç, —Ä–µ–ª–µ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è, –Ω–æ UDP-–ø–∞–∫–µ—Ç—ã –æ—Ç peers –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç.

## –í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞

–£ —Ö–æ—Å—Ç–µ—Ä–∞ (Beget, Hetzner, DigitalOcean –∏ —Ç.–ø.) –º–æ–∂–µ—Ç –±—ã—Ç—å **—Å–≤–æ–π —Ñ–∞–π—Ä–≤–æ–ª** –≤ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–π UDP –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤ **49152‚Äì65535** (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è TURN relay).

---

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã –≤ –ø–∞–Ω–µ–ª–∏ —Ö–æ—Å—Ç–∏–Ω–≥–∞

–ó–∞–π–¥–∏—Ç–µ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPS —É –≤–∞—à–µ–≥–æ —Ö–æ—Å—Ç–µ—Ä–∞ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ:

- **3478** ‚Äî UDP –∏ TCP (–æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ä—Ç TURN)
- **49152‚Äì65535** ‚Äî **UDP** (–¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è TURN relay)

–ï—Å–ª–∏ –≤ –ø–∞–Ω–µ–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–¥–µ–ª "Firewall" / "–°–µ—Ç—å" / "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏" ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —ç—Ç–∏—Ö –ø–æ—Ä—Ç–æ–≤.

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å TURN —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞

–ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–æ–≤ –≤ –ø–∞–Ω–µ–ª–∏ —Ö–æ—Å—Ç–∏–Ω–≥–∞:

- –ü–æ–∑–≤–æ–Ω–∏—Ç–µ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –ü–ö.
- –í –ª–æ–≥–∞—Ö –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ (–Ω–∞–∂–º–∏—Ç–µ ¬´üìã –õ–æ–≥–∏¬ª –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏):
  ```
  ICE: relay (TURN only, mobile caller)
  ICE candidate (local)
  ...–º–Ω–æ–≥–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...
  event call:answer chatId=...
  received call:answer, setting remote description
  received ICE candidate (remote)
  iceConnectionState (caller): checking
  iceConnectionState (caller): connected   <--- —ç—Ç–æ –≥–ª–∞–≤–Ω–æ–µ
  ```

–ï—Å–ª–∏ ICE –¥–æ—Ö–æ–¥–∏—Ç –¥–æ `connected`, TURN —Ä–∞–±–æ—Ç–∞–µ—Ç.

### 3. –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–æ–≤ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É failed

- **–õ–æ–≥–∏ coturn:** –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ VPS:
  ```bash
  tail -100 /var/log/turnserver/turnserver.log
  ```
  –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å –≤–∞—à–∏–º IP —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (remote) –∏ peers ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å established –∏–ª–∏ —É—Å–ø–µ—à–Ω—ã–π –æ–±–º–µ–Ω —Ç—Ä–∞—Ñ–∏–∫–æ–º (rp/rb/sp/sb > 0).

- **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å TURN —Å –ü–ö:** –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –ü–ö –æ—Ç–∫—Ä–æ–π—Ç–µ https://webrtc.github.io/samples/src/content/peerconnection/trickle-ice/, –¥–æ–±–∞–≤—å—Ç–µ TURN:
  ```
  turn:89.169.39.244:3478
  username: turn_fdf8b6e8
  credential: (–ø–∞—Ä–æ–ª—å –∏–∑ /var/www/messager/frontend-web/.env.production)
  ```
  –ù–∞–∂–º–∏—Ç–µ "Gather candidates" ‚Äî –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è `relay` –∫–∞–Ω–¥–∏–¥–∞—Ç—ã, –µ—Å–ª–∏ TURN –¥–æ—Å—Ç—É–ø–µ–Ω —Å –ü–ö.

---

## –ö—Ä–∞—Ç–∫–∞—è —Å—Ö–µ–º–∞

| –ü–æ—Ä—Ç/–¥–∏–∞–ø–∞–∑–æ–Ω | –ü—Ä–æ—Ç–æ–∫–æ–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ì–¥–µ –æ—Ç–∫—Ä—ã—Ç—å |
|---------------|----------|------------|-------------|
| 3478 | UDP | TURN | –ü–∞–Ω–µ–ª—å —Ö–æ—Å—Ç–∏–Ω–≥–∞ |
| 3478 | TCP | TURN | –ü–∞–Ω–µ–ª—å —Ö–æ—Å—Ç–∏–Ω–≥–∞ |
| 49152‚Äì65535 | UDP | TURN relay (–º–µ–¥–∏–∞) | **–ü–∞–Ω–µ–ª—å —Ö–æ—Å—Ç–∏–Ω–≥–∞** (–∫—Ä–∏—Ç–∏—á–Ω–æ!) |

–ï—Å–ª–∏ UDP 49152‚Äì65535 –∑–∞–∫—Ä—ã—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ö–æ—Å—Ç–µ—Ä–∞, relay –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Üí ICE –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ —É—Ö–æ–¥–∏—Ç –≤ failed ‚Üí –∑–≤–æ–Ω–æ–∫ –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

---

## –ü–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ—Ä—Ç–æ–≤

–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å coturn –Ω–µ –Ω—É–∂–Ω–æ. –°—Ä–∞–∑—É –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–≤–æ–Ω–æ–∫ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –ü–ö –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏.
