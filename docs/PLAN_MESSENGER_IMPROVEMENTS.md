# План изменений и дополнений мессенджера

Документ сопоставляет текущее состояние с требованиями и разбивает работу на этапы.

---

## Важно: единый формат веб и мобильных приложений

**После реализации разработки веб-версии и мобильных приложений (Android/iOS) обязательно привести все клиенты к единому формату:**

- **Визуально** — один и тот же визуальный вид: цвета, типографика, расположение элементов, иконки, отступы, тёмная/светлая тема. Пользователь не должен замечать разницы при переходе с веб-версии на приложение и обратно.
- **Функционально** — одинаковая функциональность: одни и те же экраны (вход, список чатов, чат, настройки), одни и те же действия (отправка текста/медиа/голоса, ответ, пересылка, удаление, звонки, уведомления). Если в вебе есть новая фича — она должна появиться в приложениях (и наоборот), с учётом ограничений платформы.

Этот шаг выполняется **обязательно** после этапов 0–13 и после реализации мобильных приложений по [MOBILE_ANDROID_IOS_PLAN.md](./MOBILE_ANDROID_IOS_PLAN.md). Детали — в **Этапе 14** ниже.

---

## Панель ввода сообщений (интерфейс в стиле Telegram)

Ниже — целевое описание панели ввода по образцу интерфейса Telegram: упрощённая и интуитивная панель с минимумом кнопок.

### Структура панели (слева → направо)

| Порядок | Элемент | Описание и функциональность |
|--------|---------|-----------------------------|
| **1** | **Иконка смайлика (слева)** | Иконка эмодзи слева от поля ввода. По нажатию открывается панель с эмодзи и стикерами; выбранные символы вставляются в поле ввода (в текущую позицию или в конец). |
| **2** | **Поле ввода текста (центр)** | Центральная часть панели. Пользователь вводит текст сообщения; поле автоматически увеличивается по высоте при переносе строк (ограниченный максимум, далее скролл). |
| **3** | **Иконка прикрепления (скрепка/папка)** | Справа от поля ввода. По нажатию открывается выбор файлов (файловый менеджер): изображения, документы, медиа. Выбранные файлы можно отправить вместе с текстом или отдельно. |
| **4** | **Иконка отправки (стрелка)** | Справа на панели. Кнопка активна только когда есть введённый текст или выбранные файлы; по нажатию сообщение отправляется. При загрузке медиа/голоса — отображать состояние отправки (иконка загрузки). |

### Общие принципы

- **Упрощённый интерфейс:** только нужные элементы, без лишних кнопок.
- **Интуитивность:** привычный вид мессенджера, быстрый доступ к эмодзи, вложениям и отправке.
- **Адаптивность:** панель корректно работает на разных ширинах экрана (мобильные и десктоп).

### Дополнительно: голосовые сообщения

Запись голоса можно реализовать одним из вариантов, не меняя основной порядок элементов:

- иконка микрофона рядом со смайликом (слева от поля), или  
- долгое нажатие на кнопку отправки переключает режим «запись голоса» (как в Telegram).

В плане этапов ниже порядок элементов приведён к варианту: **смайлик | поле ввода | скрепка | отправка**; микрофон добавляется при реализации записи аудио (этап 2).

---

## Сводка: что есть / что нужно

| № | Блок | Сейчас | Нужно по ТЗ |
|---|------|--------|-------------|
| 1 | Поле ввода | Однострочный `input`, микрофон отдельно, нет фото/эмодзи | Панель в стиле Telegram: смайлик (слева) \| textarea с авторостом \| скрепка (вложения) \| иконка отправки справа |
| 2 | Кнопка отправки | Текст «Отправить», не иконка | Иконка стрелки, неактивна если пусто, при отправке медиа/голоса — иконка загрузки |
| 3 | Запись аудио | Клик → запись → стоп → превью → отправить/отмена | Удержание для записи, свайп для отмены, превью перед отправкой (частично есть) |
| 4 | Фото/видео | Нет | Иконка справа, меню «камера / галерея», превью, отправка в чат |
| 5 | Эмодзи/стикеры | Нет | Иконка смайлика, панель выбора, вставка в поле ввода |
| 6 | Список контактов | Есть список чатов, аватары, онлайн, unread | + фильтр по недавним/активности; на десктопе — список слева от чата (опционально) |
| 7 | Меню настроек | Только «Выйти» внизу списка чатов | Отдельная страница/меню: профиль, уведомления, конфиденциальность, выход |
| 8 | Фото/видео в чате | Нет | Миниатюры в сообщениях, клик — полноэкран, видео — воспроизведение в чате |
| 9 | Статусы сообщений | Есть: отправлено/доставлено/прочитано | Оставить как есть, при необходимости доработать в реальном времени |
| 10 | Звонки | Есть кнопки в шапке чата, VideoCall | Состояния «звоним/соединяемся/завершён» — частично есть, доработать отображение |
| 11 | Удаление сообщений | Режим выбора → удалить выбранные (только у себя) | Долгое нажатие → меню (удалить, ответить, переслать); опция «удалить у всех» (если настроено) |
| 12 | Ответ на сообщение | Нет | Долгое нажатие → «Ответить», цитата в чате, API replyTo |

---

## Порядок реализации (сводка)

Рекомендуемая последовательность с учётом зависимостей и интеграции UX-рекомендаций:

1. **Этап 0** — быстрые победы: единая тема, тосты, пустые состояния, обработка ошибок, токены цветов.
2. **Этап 1** — поле ввода и кнопка отправки (+ Enter/Shift+Enter, фокус, кнопка «Назад»).
3. **Этап 2** — запись аудио (удержание, свайп).
4. **Этап 4** — эмодзи.
5. **Этап 3 + 8** — фото/видео: backend, выбор, отображение в чате.
6. **Этап 11** — скелетоны загрузки (список чатов и чат).
7. **Этап 6** — меню настроек (профиль, уведомления, выход).
8. **Этап 5** — список контактов: фильтры, **поиск по чатам**, layout десктопа.
9. **Этап 7** — статусы сообщений.
10. **Этап 9** — звонки (+ кнопка «Отклонить» заметнее, вибрация при входящем).
11. **Этап 10** — долгое нажатие, ответ, пересылка, удаление.
12. **Этап 12** — полировка UX: разделители дат, прокрутка к новым сообщениям, a11y, индикатор подключения, оптимистичное обновление.
13. **Этап 13** — опционально: виртуализация сообщений, превью ссылок, онбординг, горячие клавиши, мобильное приложение (Safe Area, жесты, haptic).
14. **Этап 14 (обязательно)** — приведение веб-версии и мобильных приложений к единому визуальному виду и одинаковой функциональности.

---

## Этап 0. Быстрые победы (UX-рекомендации)

**Цель:** Единый визуальный стиль, понятная обратная связь и устойчивость к ошибкам до начала доработки функционала.

### 0.1 Единая тема входа и регистрации

- [ ] Привести страницы Login и Register к тёмной теме приложения: фон `#0b0b0b` (или из токенов), текст светлый, поля ввода в стиле `#2d2d2f`, акцент `#0a84ff`. Чтобы переход «вход → список чатов» был без резкой смены темы.

### 0.2 Токены цветов

- [ ] Вынести цвета в переменные (CSS-переменные или Tailwind theme): фон, акцент, текст, вторичный текст (`#86868a`), границы. Использовать их везде (включая Login/Register после 0.1).

### 0.3 Тосты вместо alert

- [ ] Реализовать компонент Toast и контекст (или хук): показ короткого сообщения внизу/сверху экрана без блокировки интерфейса.
- [ ] Заменить все вызовы `alert(...)` на тост (ошибки входа/регистрации, создание чата, ошибки отправки и т.д.).

### 0.4 Пустое состояние в чате

- [ ] При отсутствии сообщений в чате показывать текст «Начните переписку» или «Отправьте первое сообщение» (и при желании подсказку по действиям: эмодзи, вложения, звонок).

### 0.5 Обработка ошибок загрузки

- [ ] Если не удалось загрузить чат или список сообщений — показывать короткое сообщение об ошибке и кнопку «Повторить» вместо пустого экрана или бесконечной загрузки.

### 0.6 Единый стиль иконок и кнопок

- [ ] Зафиксировать единый размер иконок (например 20×20 / 24×24), одинаковые отступы у кнопок, один стиль скругления (например `rounded-xl`) и использовать везде.

**Зависимости:** нет.  
**Файлы:** `LoginPage.tsx`, `RegisterPage.tsx`, `index.css` (или tailwind.config), новый `Toast.tsx` + контекст/хук, `ChatPage.tsx`, `ChatsPage.tsx`.

---

## Этап 1. Поле ввода и кнопка отправки (п. 1–2)

**Цель:** Панель в стиле Telegram: **смайлик | поле ввода | скрепка (вложения) | отправка**. Кнопка отправки — иконка стрелки, активна только при наличии текста или выбранных файлов.

### 1.1 Поле ввода

- [ ] Заменить `input` на `<textarea>` с авторостом по содержимому (например, `max-height: 120px`, считать строки или использовать `field-sizing: content` / JS).
- [ ] Ограничить максимальное количество строк (например, 5–6), дальше скролл внутри поля.
- [ ] Сохранить плейсхолдер и стили под текущий дизайн.

### 1.2 Расположение элементов (как на панели Telegram)

- [ ] **Слева:** иконка смайлика — открывает панель эмодзи, вставка выбранных символов в поле ввода.
- [ ] **Центр:** поле ввода текста, адаптирующееся по высоте.
- [ ] **Справа от поля:** иконка прикрепления (скрепка/папка) — открывает файловый менеджер для выбора изображений, документов и других медиа.
- [ ] **Справа с краю:** кнопка отправки (иконка стрелки); активна только когда есть текст или выбранные файлы.
- [ ] Иконка микрофона для голосовых сообщений: либо рядом со смайликом, либо по долгому нажатию на кнопку отправки (реализуется в этапе 2).
- [ ] Адаптивность: на мобильном все элементы в одну строку; при нехватке места — компактное отображение или вынос части функций под «+».

### 1.3 Кнопка отправки (п. 2)

- [ ] Заменить текст «Отправить» на иконку отправки (стрелка).
- [ ] Включена только если есть текст или выбранные медиа/голосовое (логика с учётом п. 4–5).
- [ ] При отправке голоса/медиа показывать состояние загрузки (иконка загрузки / спиннер), блокировать повторную отправку.

### 1.4 Удобство ввода и навигации (UX-рекомендации)

- [ ] **Enter — отправка, Shift+Enter — новая строка** (при переходе на textarea).
- [ ] При открытии чата давать фокус полю ввода (десктоп).
- [ ] На мобильной ширине: явная кнопка «Назад» (стрелка влево) в шапке чата для возврата к списку чатов.

**Зависимости:** нет.  
**Файлы:** `ChatPage.tsx`, при необходимости отдельный компонент `MessageInput.tsx`.

---

## Этап 2. Запись аудио (п. 3)

**Цель:** Удержание микрофона = запись, отпускание = конец записи, свайп = отмена. Превью перед отправкой уже есть.

### 2.1 Удержание для записи

- [ ] На микрофоне: `onPointerDown` → начать запись, `onPointerUp` / `onPointerLeave` (при уходе за область) → остановить запись.
- [ ] Визуальная обратная связь: индикатор записи (волны/пульс/таймер) рядом с кнопкой или над полем ввода.

### 2.2 Отмена свайпом

- [ ] Во время записи показывать подсказку «свайп в сторону для отмены».
- [ ] Отслеживать горизонтальное движение пальца/мыши от начальной точки; при свайпе за порог — отменить запись (без сохранения), скрыть превью.

### 2.3 Превью и отправка

- [ ] После окончания записи оставить текущее превью (проигрыватель + «Отправить» / «Отмена») без изменений по логике.
- [ ] При отправке голоса показывать на кнопке отправки состояние загрузки (п. 1.3).

**Зависимости:** этап 1 (общая строка с кнопкой отправки).  
**Файлы:** `VoiceRecorder.tsx`, `ChatPage.tsx`.

---

## Этап 3. Выбор фото и видео (п. 4)

**Цель:** Иконка «фото/видео» → меню (камера / галерея) → выбор файлов → превью → отправка. В чате — миниатюры (этап 8).

### 3.1 Backend

- [ ] Расширить модель/API сообщений: тип «image»/«video», поле для URL медиа (или отдельная сущность вложений).
- [ ] Эндпоинт загрузки файлов (multipart): приём изображений и видео, сохранение в `uploads/images`, `uploads/videos`, возврат URL.
- [ ] В создании сообщения передавать `messageType`, `imageUrl` / `videoUrl` (или общее `attachments`).
- [ ] WebSocket: при рассылке нового сообщения отдавать получателям данные о медиа.

### 3.2 Frontend — выбор и превью

- [ ] Компонент или кнопка «вложения»: по нажатию — меню «Камера» / «Галерея (файлы)».
- [ ] Камера: `getUserMedia` + захват кадра или запись короткого видео; либо ссылка на `input[type=file] accept="image/*" capture="environment"`.
- [ ] Галерея: `input type="file" accept="image/*,video/*" multiple` — файловый менеджер устройства.
- [ ] После выбора — превью (миниатюры) над/под полем ввода с возможностью убрать файл из списка.
- [ ] Кнопка отправки активна при наличии выбранных медиа; при нажатии — загрузка на сервер, создание сообщения, обновление чата.

### 3.3 Отображение в чате (п. 8)

- [ ] В списке сообщений: если у сообщения есть `imageUrl`/`videoUrl` — показывать миниатюру.
- [ ] Клик по изображению: полноэкранный просмотр (модальное окно или отдельный экран).
- [ ] Видео: тег `<video controls>` в сообщении или в превью; по клику можно открыть в полноэкранном режиме.

**Зависимости:** этап 1 (кнопка отправки и общая строка).  
**Файлы:** backend: `messages` (controller, service, DTO), `uploads`; frontend: `ChatPage.tsx`, компонент превью медиа, типы `Message`.

---

## Этап 4. Эмодзи и стикеры (п. 5)

**Цель:** Иконка смайлика **слева от поля ввода** (как на панели Telegram) открывает панель с эмодзи и стикерами; выбранные символы вставляются в поле ввода; отправка — кнопкой отправки справа.

### 4.1 Панель эмодзи

- [ ] Компонент `EmojiPicker`: сетка эмодзи (например, по категориям или один набор). Можно использовать библиотеку (emoji-picker-react и т.п.) или свой небольшой набор.
- [ ] По клику на эмодзи — вставка символа в текущую позицию в `textarea` (или в конец).
- [ ] Панель открывается по клику на иконку смайлика; повторный клик или клик вне — закрытие.

### 4.2 Стикеры (опционально)

- [ ] Отдельная вкладка/секция в панели или отдельная кнопка «стикеры».
- [ ] Стикер — изображение; при выборе отправлять как сообщение с типом «sticker» и URL (либо как специальное текстовое/медиа-сообщение). Backend: при необходимости новый тип сообщения и хранение стикеров.

### 4.3 Интеграция

- [ ] Иконка смайлика в строке ввода **слева от поля** (согласно панели в стиле Telegram).
- [ ] Состояние «открыта панель эмодзи» не блокирует отправку текста кнопкой; после вставки эмодзи пользователь нажимает отправку как обычно.

**Зависимости:** этап 1 (textarea и строка ввода).  
**Файлы:** компонент `EmojiPicker.tsx`, `ChatPage.tsx` или `MessageInput.tsx`.

---

## Этап 5. Список контактов (п. 6)

**Цель:** Уточнить расположение и добавить фильтрацию.

### 5.1 Текущее состояние

- Уже есть: аватары, имена, последняя активность/время, индикатор онлайн, счётчик непрочитанных. Клик по чату открывает чат.

### 5.2 Доработки

- [ ] Фильтр: «Все» / «Недавние» / «Активные» (например, сортировка по `lastMessageAt` или по онлайн). Вкладки или выпадающий список над списком чатов.
- [ ] **Поиск по чатам:** поле поиска над списком чатов — фильтр по имени контакта/чата без перехода в «Новый чат»; дебаунс ~300 ms как у поиска пользователей.
- [ ] На десктопе (по желанию): layout «список чатов слева | чат справа», чтобы не переключать экраны. Роутинг можно оставить `/` и `/chat/:chatId`, на широком экране рендерить список и чат рядом.

**Зависимости:** нет.  
**Файлы:** `ChatsPage.tsx`, при необходимости разбить на компоненты (ChatList, ChatListItem).

---

## Этап 6. Меню настроек (п. 7)

**Цель:** Отдельное меню/страница настроек: профиль, уведомления, конфиденциальность, выход.

### 6.1 Доступ

- [ ] Кнопка «меню» (иконка гамбургера или шестерёнки) в правом верхнем углу списка чатов (или в шапке профиля).
- [ ] По нажатию: выпадающее меню или переход на страницу `/settings`.
- [ ] Убрать отдельную кнопку «Выйти» из низа списка чатов — выход только через страницу настроек (или пункт «Выйти» в выпадающем меню).

### 6.2 Разделы

- [ ] **Профиль:** имя, фото (аватар), статус. Редактирование через форму; бэкенд: PATCH `/users/me` и загрузка аватара.
- [ ] **Уведомления:** звуки, вибрация, уведомления о сообщениях (вкл/выкл). Хранение в localStorage или в настройках пользователя на бэкенде (при наличии таблицы настроек).
- [ ] **Конфиденциальность:** кто видит последнюю активность, возможность скрыть «был(а) в сети». Backend: при необходимости поля в профиле и API.
- [ ] **Выход:** текущая логика logout; пункт в меню настроек или внизу страницы настроек.

### 6.3 Применение

- [ ] Изменения профиля сохраняются на сервер и сразу отображаются в шапке и в списке чатов (имя/аватар).
- [ ] Настройки уведомлений применяются без перезагрузки (если хранятся на клиенте).

**Зависимости:** нет (профиль может опираться на существующий API пользователя).  
**Файлы:** новая страница `SettingsPage.tsx`, маршрут `/settings`, backend: при необходимости `users` (update profile, avatar, settings).

---

## Этап 7. Статусы сообщений (п. 9)

**Цель:** Убедиться, что статусы «Отправлено / Доставлено / Прочитано» отображаются и обновляются в реальном времени.

### 7.1 Проверка и доработка

- [ ] Сейчас: `deliveryStatus`, галочки в сообщениях. Проверить, что при доставке и прочтении сервер рассылает события и фронт обновляет статус.
- [ ] При необходимости доработать WebSocket-события и обновление состояния на фронте (например, при открытии чата — mark as read, сервер шлёт обновление статуса отправителю).

**Зависимости:** нет.  
**Файлы:** `ChatPage.tsx`, `websocket.service.ts`, backend gateway.

---

## Этап 8. Отображение фото и видео в чате (п. 8)

Описание — см. этап 3.3. Реализовать вместе с загрузкой фото/видео (этап 3) или сразу после: миниатюры в сообщениях, клик — полноэкран, видео с воспроизведением.

---

## Этап 9. Звонки (п. 10)

**Цель:** Явные состояния «звоним», «соединяемся», «завершён» и минималистичное управление.

### 9.1 Состояния

- [ ] При исходящем: экран «Звоним…» до появления ответа/отклонения.
- [ ] После ответа: «Соединяемся…» до установки медиа-потоков.
- [ ] В разговоре: текущий UI (видео/голос + управление).
- [ ] После завершения: краткое «Звонок завершён» или сразу закрытие (как сейчас).

### 9.2 Управление

- [ ] Убедиться, что во время звонка видны: выключение микрофона, выключение камеры (для видео), завершение звонка. Сейчас это уже есть в `VideoCall.tsx`; при необходимости подправить расположение и стили.

### 9.3 Входящий звонок (UX-рекомендации)

- [ ] На экране входящего звонка кнопка «Отклонить» — крупнее и заметнее (например красная), чтобы снизить случайные принятия.
- [ ] На мобильном приложении: короткая вибрация при входящем звонке (звук уже есть).

**Зависимости:** нет.  
**Файлы:** `VideoCall.tsx`, при необходимости `ChatPage.tsx`.

---

## Этап 10. Удаление, ответ, пересылка (п. 11–12)

**Цель:** Долгое нажатие на сообщение → меню «Удалить / Ответить / Переслать». Ответ с цитированием. Удаление «у всех» (опционально).

### 10.1 Контекстное меню по долгому нажатию

- [ ] На каждом сообщении: `onContextMenu` или обработчик долгого нажатия (touch: `touchstart` + таймер ~500 ms; mouse: `mousedown` + таймер). Показать меню: «Ответить», «Переслать», «Удалить».
- [ ] «Удалить» — только для своих сообщений (как сейчас). При необходимости добавить вариант «Удалить у всех» (см. п. 10.3).

### 10.2 Ответ на сообщение

- [ ] Backend: в модели сообщения поле `replyToMessageId` (или `parentId`). API создания сообщения принимает `replyToMessageId`. При отдаче сообщений отдавать данные цитируемого сообщения (id, текст/тип, автор).
- [ ] Frontend: при выборе «Ответить» — сохранить `replyToMessageId`, над полем ввода показать превью цитаты («Ответ на: …»). Отправка — обычная с этим полем.
- [ ] В списке сообщений: если у сообщения есть ответ — показывать блок цитаты над текстом (имя/текод/тип исходного сообщения).

### 10.3 Пересылка

- [ ] «Переслать» открывает выбор чата (или контакта). После выбора — отправить в выбранный чат сообщение с тем же содержимым и пометкой «Пересланное» (и при необходимости `forwardedFromMessageId` в backend).

### 10.4 Удаление «у всех»

- [ ] Опционально: настройка «удалять у всех» в настройках или в контекстном меню. Backend: эндпоинт «удалить сообщение у всех» (доступ только автору, в ограниченное время). Frontend: пункт «Удалить у всех» в меню и вызов API.

**Зависимости:** нет.  
**Файлы:** backend: `messages` (schema, service, controller), WebSocket; frontend: `ChatPage.tsx`, типы `Message`, компонент превью цитаты, модальное окно выбора чата для пересылки.

---

## Этап 11. Скелетоны загрузки (UX-рекомендации)

**Цель:** Убрать «прыгающий» интерфейс при загрузке: вместо одного слова «Загрузка...» показывать скелетоны по форме контента.

### 11.1 Список чатов

- [ ] На `ChatsPage` при `loading === true` показывать скелетон: ряд прямоугольников по форме аватара + две строки текста (имя, подпись). Количество строк 5–8.

### 11.2 Чат (лента сообщений)

- [ ] При загрузке сообщений чата показывать скелетон: «пузыри» сообщений (прямоугольники разной ширины слева/справа) или ряд блоков по форме сообщения.

**Зависимости:** этапы 0–1 (страницы уже есть).  
**Файлы:** `ChatsPage.tsx`, `ChatPage.tsx`, при необходимости общий компонент `Skeleton.tsx`.

---

## Этап 12. Полировка UX: чат, доступность, обратная связь

**Цель:** Разделители дат в ленте, прокрутка к новым сообщениям, доступность (a11y), индикатор подключения, согласованность оптимистичного обновления.

### 12.1 Разделители дат в чате

- [ ] В ленте сообщений вставлять подпись «Сегодня», «Вчера», «15 января» между блоками сообщений по дате (при смене дня).

### 12.2 Прокрутка к новым сообщениям

- [ ] При получении нового сообщения: если пользователь уже внизу — плавно прокручивать вниз; иначе показывать кнопку «N новых» внизу, по нажатию — прокрутка к новым. Проверить поведение на мобильных.

### 12.3 Доступность (a11y)

- [ ] **Фокус и клавиатура:** все интерактивные элементы доступны с Tab, фокус виден (например `ring-2 ring-[#0a84ff]`), в модалках фокус не уходит «за» экран.
- [ ] **Семантика и ARIA:** список чатов — `role="list"` / `listitem`, область сообщений — `region` с `aria-label`; у всех кнопок без текста — `aria-label`.
- [ ] **Контраст:** проверить контраст вторичного текста (`#86868a`) на фоне (WCAG AA); при необходимости чуть осветлить.

### 12.4 Индикатор подключения

- [ ] В шапке списка чатов или чата (дополнительно к `ConnectionBanner`) — маленький индикатор «В сети» / «Переподключение» (зелёный/серый), опционально.

### 12.5 Оптимистичное обновление и сбой отправки

- [ ] При отправке сообщения сразу показывать его в чате со статусом «отправляется»; при успехе — «доставлено»/«прочитано». При ошибке сети/сервера — тост «Не удалось отправить. Повторить?» или кнопка «Повторить» рядом с сообщением.

**Зависимости:** этапы 0 (тосты), 1, 10.  
**Файлы:** `ChatPage.tsx`, `ChatsPage.tsx`, компоненты списка сообщений и шапки.

---

## Этап 13. Опционально: производительность, онбординг, мобильное приложение

**Цель:** Улучшения по желанию: виртуализация, превью ссылок, первый запуск, горячие клавиши, мобильное приложение (React Native/Expo).

### 13.1 Производительность

- [ ] **Виртуализация списка сообщений:** при большом количестве сообщений (100+) рендерить только видимую область (react-window / react-virtuoso).
- [ ] **Ленивая загрузка медиа:** изображения и видео в сообщениях — `loading="lazy"`, при необходимости placeholder до загрузки.

### 13.2 Превью ссылок

- [ ] Для сообщений, содержащих URL, показывать превью (title, description, картинка) — опционально.

### 13.3 Онбординг и подсказки

- [ ] После первого входа — 1–2 экрана: «Добавьте контакт и начните чат» / «Нажмите + для нового чата», кнопка «Понятно».
- [ ] При первом открытии чата — тултип «Здесь можно писать сообщения и звонить» (один раз, флаг в localStorage).

### 13.4 Горячие клавиши (десктоп)

- [ ] Escape — закрыть модалку, панель эмодзи, экран входящего звонка.
- [ ] Опционально: Ctrl+K — фокус в поиск чата.

### 13.5 Мобильное приложение (React Native / Expo)

- [ ] **Safe Area:** учитывать вырезы и индикатор домашней строки (SafeAreaView / insets).
- [ ] **Клавиатура:** при открытии поля ввода поднимать панель ввода вместе с клавиатурой (KeyboardAvoidingView).
- [ ] **Жесты:** свайп назад для выхода из чата; при необходимости свайп по сообщению для ответа/удаления.
- [ ] **Haptic feedback:** лёгкая вибрация при нажатии кнопок (отправка, ответ на звонок) — по желанию.

**Зависимости:** основные этапы 0–12 выполнены.  
**Файлы:** frontend-web (виртуализация, превью, онбординг, горячие клавиши); mobile/ (Safe Area, клавиатура, жесты, haptic).

---

## Этап 14. Единый формат: веб и мобильные приложения (обязательно)

**Цель:** После реализации веб-версии и мобильных приложений привести все клиенты к одному визуальному виду и одинаковой функциональности. Это обязательный финальный шаг.

### 14.1 Визуальное единство

- [ ] **Общая дизайн-система:** один набор цветов (фон, акцент, текст, вторичный текст, границы), размеры шрифтов, скругления, отступы. Описать в общем документе или в коде (CSS-переменные / тема Tailwind для веба, те же значения в React Native для mobile).
- [ ] **Веб:** убедиться, что frontend-web использует только эти токены (включая Login/Register, список чатов, чат, настройки).
- [ ] **Мобильные приложения:** повторить те же цвета, размеры и пропорции в mobile (StyleSheet / тема). Иконки — те же или из одного набора (например SF Symbols / Material + общие SVG).
- [ ] **Экраны/страницы:** один и тот же набор экранов с одинаковой структурой (шапка, контент, нижняя панель ввода в чате). Расположение кнопок и полей совпадает.

### 14.2 Функциональное единство

- [ ] **Чеклист функций:** составить список всех функций веб-версии (вход/регистрация, список чатов, поиск, новый чат, чат с текстом/медиа/голосом, ответ/пересылка/удаление, звонки, настройки, уведомления). Для каждой проверить: есть ли то же самое в мобильных приложениях (с учётом платформы: push, фоновый режим — только в приложениях).
- [ ] **Веб:** при появлении новой фичи в плане — реализовать в frontend-web и зафиксировать в чеклисте.
- [ ] **Мобильные приложения:** реализовать те же фичи в mobile (или явно задокументировать ограничение платформы). Не допускать ситуации, когда в вебе есть возможность, а в приложении — нет (кроме технически невозможного).
- [ ] **API и данные:** веб и приложения используют одни и те же API и форматы данных; различия только в представлении (адаптация под экран).

### 14.3 Синхронизация при дальнейшей разработке

- [ ] При добавлении новой функции: сначала определить, где она будет (веб, mobile, оба); реализовать в обоих клиентах с одним визуальным и поведенческим результатом.
- [ ] Документировать исключения: что по объективным причинам есть только в вебе (например сложный drag-and-drop) или только в приложениях (push, фон, haptic).

**Зависимости:** этапы 0–13 по веб-версии; реализация мобильных приложений по MOBILE_ANDROID_IOS_PLAN.md.  
**Файлы:** frontend-web (все страницы и компоненты), mobile/ (все экраны и компоненты), при необходимости общий документ «Дизайн-система Messager» или README с токенами.

---

## Рекомендуемый порядок выполнения

1. **Этап 0** — быстрые победы: единая тема, тосты, пустые состояния, обработка ошибок, токены цветов.
2. **Этап 1** — поле ввода и кнопка отправки (+ Enter/Shift+Enter, фокус, кнопка «Назад»).
3. **Этап 2** — доработка записи аудио (удержание, свайп).
4. **Этап 4** — эмодзи (без медиа на backend).
5. **Этап 3 + 8** — фото/видео: backend + выбор + отображение в чате.
6. **Этап 11** — скелетоны загрузки (список чатов и чат).
7. **Этап 6** — настройки и меню.
8. **Этап 5** — фильтры списка контактов, поиск по чатам, layout десктопа.
9. **Этап 7** — проверка статусов сообщений.
10. **Этап 9** — уточнение состояний звонка (+ кнопка «Отклонить», вибрация при входящем).
11. **Этап 10** — долгое нажатие, ответ, пересылка, удаление.
12. **Этап 12** — полировка UX: разделители дат, прокрутка, a11y, индикатор подключения, оптимистичное обновление.
13. **Этап 13** — опционально: виртуализация, превью ссылок, онбординг, горячие клавиши, мобильное приложение.
14. **Этап 14 (обязательно)** — приведение веб-версии и мобильных приложений к единому визуальному виду и одинаковой функциональности.

---

## Общие требования (из ТЗ)

- **Интерактивность:** быстрая реакция кнопок, индикаторы при записи и загрузке.
- **Адаптивность:** корректная работа на мобильных и десктопах, поле ввода и панели доступны по ширине экрана.
- **Звонки:** понятные состояния и минималистичное, но полное управление (микрофон, камера, завершение).
- **Удаление:** явное поведение «только у себя» и при необходимости «у всех» с учётом настроек/времени.

После выполнения плана интерфейс и функциональность будут соответствовать описанным требованиям.

---

## Рекомендации по UX (интегрированы в этапы ниже)

Из документа [UI_UX_RECOMMENDATIONS.md](./UI_UX_RECOMMENDATIONS.md) в план внесены: единая тема входа/регистрации, тосты вместо alert, пустые состояния и обработка ошибок, токены цветов, скелетоны загрузки, поиск по чатам, разделители дат, доступность (a11y), кнопка «Назад» в чате, Enter/Shift+Enter, горячие клавиши, полировка звонков и опциональные улучшения (виртуализация, превью ссылок, онбординг, мобильное приложение). Они расставлены в правильной последовательности реализации в этапах 0, 1, 5, 9, 11 и 12 ниже.
