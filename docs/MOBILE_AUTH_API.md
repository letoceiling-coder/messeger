# API авторизации для Android и iOS

Документ описывает авторизацию по телефону и email для мобильных приложений Messager.

---

## 1. Базовый URL

| Среда       | URL                          |
|------------|------------------------------|
| Production | `https://neekloai.ru/api`     |
| Dev        | `http://localhost:3000/api`   |

Все эндпоинты вызываются относительно базового URL: `{BASE_URL}/auth/...`

---

## 2. Схема авторизации

```
┌─────────────┐     GET /auth/config      ┌─────────────┐
│   Клиент    │ ────────────────────────► │   Сервер    │
│ (Android/iOS)│                           │             │
└─────────────┘ ◄──────────────────────── └─────────────┘
                    { modes: ["phone","email"] }
                           │
                           ▼
┌─────────────┐   POST /auth/send-code    ┌─────────────┐
│   Клиент    │ ────────────────────────► │   Сервер    │
│ Ввод телефона│   { phone } или { email }  │ SMS / Email │
│ или email   │ ◄──────────────────────── │             │
└─────────────┘      { success: true }    └─────────────┘
                           │
                           ▼
┌─────────────┐  POST /auth/verify-code   ┌─────────────┐
│   Клиент    │ ────────────────────────► │   Сервер    │
│ Ввод кода   │  { phone/email, code }    │ Проверка    │
│             │ ◄──────────────────────── │             │
└─────────────┘  { accessToken, user }    └─────────────┘
                           │
                           ▼
┌─────────────┐
│ Сохранить   │  accessToken → secure storage
│ accessToken │  user → кэш/состояние
│ User        │  Заголовок: Authorization: Bearer {token}
└─────────────┘
```

---

## 3. Эндпоинты

### 3.1. GET /auth/config

Получить доступные режимы авторизации (режим задаётся на сервере через `AUTH_MODE`).

**Запрос:**
```
GET /auth/config
Content-Type: application/json
```
Авторизация не требуется.

**Ответ (200 OK):**
```json
{
  "modes": ["phone", "email"]
}
```
Или `["phone"]`, или `["email"]` — в зависимости от настройки сервера.

**Использование:** Показать вкладки «Телефон» / «Email» только если `modes.length > 1`.

---

### 3.2. POST /auth/send-code

Отправить код подтверждения на телефон (SMS) или email.

**Запрос:**

Телефон (только один из полей):
```json
{
  "phone": "+79991234567"
}
```

Email:
```json
{
  "email": "user@example.com"
}
```

**Формат телефона:**
- Международный: `+79991234567`, `+7 (999) 123-45-67`
- Regex: `^\+?[0-9\s\-()]{10,20}$`
- Рекомендуемая нормализация перед отправкой: только цифры, префикс `+7` для РФ

**Формат email:**
- Стандартный email (валидация по RFC)

**Ответ (200 OK):**
```json
{
  "success": true
}
```

**Ошибки (4xx):**

| Код | Сообщение | Действие |
|-----|-----------|----------|
| 400 | Укажите телефон или email | Передать phone или email |
| 400 | Укажите только телефон или только email | Не передавать оба поля |
| 400 | Введите корректный номер телефона | Проверить формат phone |
| 400 | Введите корректный email | Проверить формат email |
| 400 | Авторизация по телефону недоступна | Показать только email |
| 400 | Авторизация по email недоступна | Показать только телефон |
| 400 | Повторная отправка через N сек | Показать таймер, блокировать кнопку |
| 400 | Не удалось отправить письмо. Проверьте настройки почты. | Сообщить об ошибке, предложить телефон |
| 400 | SMS: текст ошибки от провайдера | Показать сообщение пользователю |

**Rate limit:** 60 секунд между повторными отправками на один номер/email.

---

### 3.3. POST /auth/verify-code

Проверить код и получить JWT + данные пользователя.

**Запрос:**

Для телефона:
```json
{
  "phone": "+79991234567",
  "code": "1234"
}
```

Для email:
```json
{
  "email": "user@example.com",
  "code": "1234"
}
```

**Формат code:**
- 4–6 цифр
- Только цифры: `^\d+$`

**Ответ (200 OK):**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "uuid",
    "phone": "+79991234567",
    "email": null,
    "username": "user_123456",
    "avatarUrl": null
  }
}
```

Если пользователь новый — он создаётся автоматически (по телефону или email).

**Ошибки (4xx):**

| Код | Сообщение | Действие |
|-----|-----------|----------|
| 400 | Укажите телефон или email | Передать phone или email |
| 400 | Укажите только телефон или только email | Не передавать оба поля |
| 400 | Введите корректный номер телефона | Проверить формат phone |
| 400 | Введите корректный email | Проверить формат email |
| 400 | **Неверный или истёкший код** | Показать ошибку, дать ввести код заново или запросить новый |
| 400 | Код должен быть 4–6 цифр | Проверить длину/формат code |

---

## 4. Использование токена

После успешного `verify-code` сохраните `accessToken` в защищённом хранилище (Keychain / Keystore).

Для всех защищённых запросов добавляйте заголовок:
```
Authorization: Bearer {accessToken}
```

**Пример:** Получение текущего пользователя
```
GET /users/me
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

При `401 Unauthorized` — токен истёк или невалиден: выйти из учётки и показать экран авторизации.

---

## 5. Обработка неверного кода

| Ситуация | Ответ сервера | Действие клиента |
|----------|---------------|------------------|
| Код неверный | 400, `"Неверный или истёкший код"` | Показать сообщение под полем ввода, подсветить поле, не сбрасывать введённый номер/email |
| Код истёк | 400, `"Неверный или истёкший код"` | То же + предложить «Отправить код повторно» |
| Код 3 цифры | 400, `"Код должен быть 4–6 цифр"` | Валидация на клиенте до отправки; при ответе сервера — показать сообщение |

Пользователь должен всегда видеть понятное сообщение об ошибке.

---

## 6. Хранение данных

| Данные | Где хранить | Примечание |
|--------|-------------|------------|
| accessToken | Keychain (iOS) / EncryptedSharedPreferences (Android) | Не в UserDefaults/SharedPreferences без шифрования |
| user (id, username, phone, email, avatarUrl) | Локальный кэш/состояние | Для отображения без запроса /users/me |
| pendingIdentifier (phone/email на шаге кода) | Состояние экрана / ViewModel | Не сохранять в постоянное хранилище |

---

## 7. Примеры (cURL)

**1. Узнать режимы:**
```bash
curl -X GET https://neekloai.ru/api/auth/config
```

**2. Запросить код на телефон:**
```bash
curl -X POST https://neekloai.ru/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79991234567"}'
```

**3. Запросить код на email:**
```bash
curl -X POST https://neekloai.ru/api/auth/send-code \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com"}'
```

**4. Проверить код:**
```bash
curl -X POST https://neekloai.ru/api/auth/verify-code \
  -H "Content-Type: application/json" \
  -d '{"phone":"+79991234567","code":"1234"}'
```

**5. Получить текущего пользователя:**
```bash
curl -X GET https://neekloai.ru/api/users/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

---

## 8. Срок действия JWT

По умолчанию токен живёт **7 дней** (`JWT_EXPIRES_IN=7d` на сервере). После истечения клиент получает `401` — нужно снова пройти авторизацию (send-code → verify-code).

---

## 9. Дополнительно

- **Логаут:** Удалить accessToken и user из локального хранилища. Серверной сессии нет — JWT stateless.
- **Маска телефона:** Для РФ рекомендовано: `+7 (XXX) XXX-XX-XX`.
- **Маска email при вводе кода:** `u***r@domain.com` — чтобы пользователь видел, на какой адрес отправлен код.
