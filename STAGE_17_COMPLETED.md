# Этап 17 — Поиск по сообщениям ✅

Дата завершения: 2026-01-30

---

## ✅ Этап 17: Поиск по сообщениям (внутри чата + глобальный)

### 17.1 Backend для поиска по сообщениям ✅

**Реализовано:**

#### Методы в `MessagesService`:

```typescript
/** Поиск сообщений в конкретном чате */
async searchInChat(chatId: string, userId: string, query: string) {
  // Проверка участия в чате
  // Поиск по content (LIKE)
  // Возврат до 50 результатов
}

/** Глобальный поиск по всем чатам пользователя */
async searchGlobal(userId: string, query: string) {
  // Получение всех чатов пользователя
  // Поиск по всем сообщениям в этих чатах
  // Include chat + members (для отображения)
  // Возврат до 100 результатов
}
```

#### API эндпоинты (`MessagesController`):
- `GET /messages/search/chat/:chatId?q=query` — поиск в чате
- `GET /messages/search/global?q=query` — глобальный поиск

#### Фильтрация:
- Только не удалённые сообщения (`isDeleted: false`)
- Только чаты, где пользователь активный участник (`leftAt: null`)
- Case-sensitive поиск MySQL (можно изменить на case-insensitive при необходимости)

---

### 17.2 UI поиска внутри чата ✅

**Компонент:** `ChatSearchBar.tsx`

#### Функционал:
1. **Поле поиска**
   - Автофокус при открытии
   - Debounce 300ms
   - Плейсхолдер "Поиск в чате..."

2. **Результаты**
   - Аватар отправителя
   - Имя пользователя
   - Дата сообщения
   - Текст с подсветкой найденного
   - Ограничение текста (line-clamp-2)

3. **Навигация**
   - Счётчик "1 / 10"
   - Кнопки вверх/вниз
   - Клавиатурные сокращения:
     - `Arrow Up/Down` — навигация
     - `Enter` — переход к сообщению
     - `Escape` — закрыть поиск

4. **Пустые состояния**
   - Загрузка (спиннер)
   - Ничего не найдено

#### Интеграция в `ChatPage`:
- Кнопка поиска (🔍) в шапке чата
- `ChatSearchBar` появляется под шапкой
- При клике на результат:
  - Прокрутка к сообщению (`scrollIntoView`)
  - Подсветка 3 секунды (`animate-pulse`)

---

### 17.3 Глобальный поиск по всем чатам ✅

**Компонент:** `GlobalSearchModal.tsx`

#### Функционал:
1. **Поле поиска**
   - Плейсхолдер "Поиск по всем чатам..."
   - Автофокус
   - Debounce 300ms

2. **Результаты**
   - Название чата (личный/группа)
   - Иконка группы (для групповых чатов)
   - Имя отправителя
   - Дата и время
   - Текст с подсветкой
   - Счётчик результатов внизу

3. **При клике**
   - Закрытие модального окна
   - Переход в чат (`navigate`)
   - Передача `?messageId=xxx` в URL
   - Автопрокрутка к сообщению

#### Интеграция в `ChatsPage`:
- Кнопка поиска (🔍) в шапке списка чатов (перед настройками)
- Открывает полноэкранное модальное окно

---

### 17.4 Подсветка и навигация по результатам ✅

#### Подсветка найденного текста:
```typescript
const highlightText = (text: string, highlight: string) => {
  const parts = text.split(new RegExp(`(${highlight})`, 'gi'));
  return parts.map((part, i) =>
    part.toLowerCase() === highlight.toLowerCase() ? (
      <mark key={i} className="bg-yellow-400 text-black">{part}</mark>
    ) : part
  );
};
```

#### Прокрутка к сообщению:
```typescript
const messageElement = document.getElementById(`message-${messageId}`);
if (messageElement) {
  messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
```

#### Подсветка сообщения:
- ID добавлен к элементу: `id="message-${message.id}"`
- Класс `animate-pulse` при `highlightedMessageId === message.id`
- Автоматическое снятие подсветки через 3 секунды

#### Навигация клавиатурой (ChatSearchBar):
- **↑/↓** — переключение между результатами
- **Enter** — переход к выбранному сообщению
- **Escape** — закрыть поиск

---

## Визуальные примеры

### Поиск в чате:

```
┌────────────────────────────────────┐
│ ← Иван                  🔍 ☑ 🎥 📞 │ ← кнопка поиска
├────────────────────────────────────┤
│ 🔍 [Поиск в чате...]    1/5  ↑ ↓ × │ ← панель поиска
├────────────────────────────────────┤
│ [А] Алексей       15 янв           │
│     Привет! Как <mark>дела</mark>? │
├────────────────────────────────────┤
│ [И] Иван          14 янв           │
│     У меня всё отлично, <mark>дела</mark>...│
└────────────────────────────────────┘
```

---

### Глобальный поиск:

```
┌────────────────────────────────────┐
│  🔍 [Поиск по всем чатам...]    ×  │
├────────────────────────────────────┤
│  Команда разработки 👥             │
│  Алексей          15 янв 14:30     │
│  Нужно срочно <mark>исправить</mark> баг  →│
├────────────────────────────────────┤
│  Иван                              │
│  Иван             14 янв 18:45     │
│  Как <mark>исправить</mark> эту ошибку?   →│
├────────────────────────────────────┤
│         Найдено: 2 сообщения       │
└────────────────────────────────────┘
```

---

## Технические детали

### Backend поиск (MySQL LIKE):
```typescript
where: {
  chatId,
  isDeleted: false,
  content: {
    contains: query.trim(),
  },
}
```

**Примечание:** MySQL `contains` чувствителен к регистру. Для case-insensitive можно добавить:
```typescript
content: {
  contains: query.trim(),
  mode: 'insensitive', // Для PostgreSQL
}
// Или использовать нативный SQL для MySQL
```

### Debounce на фронтенде:
```typescript
useEffect(() => {
  const debounceTimer = setTimeout(searchMessages, 300);
  return () => clearTimeout(debounceTimer);
}, [query]);
```

### Навигация по URL:
```typescript
navigate(`/chat/${message.chatId}?messageId=${message.id}`);
```

Затем в `ChatPage` можно извлечь:
```typescript
const [searchParams] = useSearchParams();
const messageId = searchParams.get('messageId');
```

---

## Файлы

### Backend:
- `backend/src/messages/messages.service.ts` (+ 95 строк)
- `backend/src/messages/messages.controller.ts` (+ 25 строк)

### Frontend:
- `frontend-web/src/components/ChatSearchBar.tsx` ✨ новый (240 строк)
- `frontend-web/src/components/GlobalSearchModal.tsx` ✨ новый (250 строк)
- `frontend-web/src/pages/ChatPage.tsx` (+ 30 строк)
- `frontend-web/src/pages/ChatsPage.tsx` (+ 15 строк)
- `frontend-web/src/services/messages.service.ts` (+ 20 строк)

### Документация:
- `STAGE_17_COMPLETED.md` ✨ новый (этот файл)

---

## Схема взаимодействия

```
User Types "привет"
       ↓
ChatSearchBar (300ms debounce)
       ↓
messagesService.searchInChat(chatId, "привет")
       ↓
GET /messages/search/chat/:chatId?q=привет
       ↓
MessagesService.searchInChat()
       ↓
Prisma: message.findMany({ content: { contains: "привет" }})
       ↓
Return [messages]
       ↓
Display results in ChatSearchBar
       ↓
User clicks result
       ↓
Scroll to message + highlight (3s)
```

---

## Улучшения в будущем

### Возможные доработки:
1. **Full-text search** — использовать MySQL FULLTEXT INDEX или Elasticsearch
2. **Фильтры:**
   - По типу сообщений (текст/медиа/голосовые)
   - По отправителю
   - По дате
3. **Превью медиа** в результатах поиска
4. **Поиск по файлам** (название, содержимое)
5. **История поисковых запросов**
6. **Подсказки** (autocomplete)
7. **Case-insensitive поиск** для MySQL:
   ```sql
   WHERE LOWER(content) LIKE LOWER('%query%')
   ```

---

## Итоги этапов 0-17

### ✅ Выполнено:
- **Этап 0** — Быстрые победы (UX)
- **Этап 1** — Поле ввода Telegram
- **Этап 2** — Запись аудио
- **Этап 4** — Эмодзи (192 шт, 8 категорий)
- **Этап 3+8** — Фото/Видео
- **Этап 11** — Скелетоны загрузки
- **Этап 6** — Настройки
- **Этап 5** — Поиск по чатам
- **Этап 7** — Статусы сообщений
- **Этап 9** — Звонки (улучшенный UI)
- **Этап 10** — Редактирование + контекстное меню
- **Этап 12** — Полировка UX (даты, прокрутка, индикаторы)
- **Этап 16** — Групповые чаты
- **Этап 17** — Поиск по сообщениям ✅

### 📊 Статистика:
- **Готовность базового функционала:** ~95% ✅
- **Новых/обновлённых файлов:** 39+
- **Строк кода:** ~4000+

---

## Следующие этапы

### 🔜 Этап 18: Реакции на сообщения
- Быстрые реакции (❤️ 👍 😂 😮 😢 🔥)
- Backend для хранения (MessageReaction)
- Отображение счётчика реакций
- Анимация добавления реакции

### 🔜 Этап 19: Статус "печатает..."
- WebSocket события `typing:start` / `typing:stop`
- Индикатор в шапке чата ("печатает...")
- Таймаут автоматического сброса
- Debounce для минимизации событий

### 🔜 Этап 20: Прикрепление документов
- Загрузка файлов (PDF, DOC, ZIP, etc.)
- Иконки типов файлов
- Отображение размера
- Скачивание файлов

---

**Статус проекта:** Поиск по сообщениям полностью реализован ✅  
**Готовность:** ~95% базового функционала  
**Следующий фокус:** Реакции на сообщения → Статус "печатает..." → Документы

**Мессенджер становится всё мощнее!** 🎉🔍
