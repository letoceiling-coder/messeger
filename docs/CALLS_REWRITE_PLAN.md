# План переработки звонков и видеозвонков (сценарий как в Telegram/WhatsApp)

## Цель

Переписать логику звонков с нуля по чёткому сценарию, с одной ответственностью на слой, без накопленных костылей. Ориентир — поведение Telegram/WhatsApp: стабильный входящий/исходящий поток, один источник правды по состоянию.

---

## Сценарий (как в мессенджерах)

### Инициатор (нажал «Позвонить»)

1. Запрос медиа (камера/микрофон) — один раз.
2. Создание `RTCPeerConnection`, добавление своих треков.
3. Создание **offer** → `setLocalDescription(offer)`.
4. Отправка **offer** на сервер (сигналинг).
5. Отправка ICE-кандидатов по мере появления (trickle).
6. Ожидание **answer** от собеседника.
7. Получение **answer** → `setRemoteDescription(answer)`, добавление удалённых ICE-кандидатов.
8. После ICE **connected** — показ удалённого потока (видео/звук).

### Принимающий (входящий звонок)

1. Получение **offer** с сервера → показ экрана «Входящий звонок» (Принять / Отклонить), рингтон.
2. По нажатию «Принять»:
   - Запрос медиа (камера/микрофон).
   - Создание `RTCPeerConnection` → `setRemoteDescription(offer)`.
   - Добавление своих треков (через transceivers / addTrack).
   - Создание **answer** → `setLocalDescription(answer)`.
   - Отправка **answer** на сервер.
   - Отправка ICE-кандидатов по мере появления.
3. После ICE **connected** — показ удалённого потока.

### Общее

- Один **WebRTC-менеджер** на активный звонок (не несколько инстансов с разным состоянием).
- Сигналинг только через WebSocket (offer / answer / ice-candidate / end / reject / no-answer).
- Удалённый поток: один раз привязать к `<video>` и `<audio>`, без пересоздания DOM (без `key` по трекам).
- Состояния: `idle` | `outgoing` | `incoming_ringing` | `connecting` | `connected` | `ended` | `failed`.

---

## Структура кода (предложение)

### 1. CallManager (один на приложение или на чат)

- Хранит: текущий звонок (chatId, роль: caller/callee), `RTCPeerConnection`, локальный и удалённый потоки, состояние.
- Методы: `startOutgoing(chatId, video)`, `acceptIncoming(offer, chatId, video)`, `reject()`, `end()`, `toggleVideo()`, `toggleMute()`.
- События: `onStateChange`, `onRemoteStream`, `onEnd`, `onError`.
- Не знает про Socket.IO напрямую — получает/отдаёт offer, answer, ice-candidate через колбэки (сигналинг абстрагирован).

### 2. Signaling (WebSocket)

- Отправка: `call:initiate`, `call:answer`, `call:ice-candidate`, `call:end`, `call:reject`.
- Приём: `call:offer`, `call:answer`, `call:ice-candidate`, `call:end`, `call:rejected`, `call:no-answer`.
- При получении событий — вызов методов CallManager (передать offer/answer/candidate).

### 3. UI (React)

- **Экран чата:** кнопки «Голосовой звонок» / «Видеозвонок» → создают исходящий звонок через CallManager.
- **Входящий звонок:** отдельный экран/модалка «Входящий от X» → Принять / Отклонить → при Принять вызывается CallManager.acceptIncoming.
- **Экран разговора:** один компонент для «во время звонка» — локальное видео (если видео), удалённое видео, удалённый звук (`<video>` + `<audio>` с одним и тем же `remoteStream`), кнопки завершить/выключить видео/микрофон.
- Состояние звонка (connecting / connected / failed) и потоки берутся из CallManager (через контекст или пропсы).

### 4. Важные моменты

- **Один RTCPeerConnection на звонок** — не создавать новый при каждом ре-рендере.
- **Удалённый поток:** привязать к элементам один раз при появлении потока; при добавлении треков обновлять тот же `srcObject` (не пересоздавать элемент по `key`).
- **Мобильный звук:** отдельный `<audio ref={remoteAudioRef} />` с `srcObject={remoteStream}` и `autoPlay` для удалённого голоса (и при видео, и при голосе).
- **TURN:** оставить в `iceServers`; не принуждать `iceTransportPolicy: 'relay'`, если TURN может быть недоступен.
- **Очистка:** при завершении звонка — закрыть PC, остановить треки, снять все слушатели сокета по этому звонку.

---

## Этапы переработки

1. **Вынести логику в CallManager** (или переименовать/упростить WebRTCService): один класс, один PC на звонок, явные состояния.
2. **Сигналинг в одном месте:** приём offer/answer/ice только там, где хранится активный звонок; не дублировать слушатели.
3. **UI только отображает состояние:** компонент «во время звонка» подписан на CallManager (state + localStream + remoteStream), не создаёт сам PC.
4. **Тесты сценариев:** исходящий с ПК на телефон, входящий с телефона на ПК, оба направления с видео и только голос.
5. **Проверка TURN:** убедиться, что порты 3478 и 49152–65535 открыты на VPS; при необходимости прогнать тест (например, trickle-ice).

---

## Текущее исправление (перед переработкой)

- Убран `key` у удалённого `<video>`, чтобы при добавлении треков элемент не пересоздавался и на телефоне не терялся `srcObject`.
- Кнопка «▶ Play» при нажатии заново выставляет `srcObject` у удалённого видео и аудио и вызывает `play()` — на случай, если привязка не сработала.

После этого можно по шагам вводить CallManager и новый сценарий без ломания текущего поведения.
