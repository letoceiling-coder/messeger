#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è SSH –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./add-ssh-key-to-server.sh dsc23ytp@–í–ê–®_–ê–î–†–ï–°_–°–ï–†–í–ï–†–ê

set -e

if [ -z "$1" ]; then
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 dsc23ytp@–ê–î–†–ï–°_–°–ï–†–í–ï–†–ê"
    echo "–ü—Ä–∏–º–µ—Ä: $0 dsc23ytp@parser-auto.site-access.ru"
    exit 1
fi

SERVER=$1
KEY_FILE="$HOME/.ssh/id_rsa.pub"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞
if [ ! -f "$KEY_FILE" ]; then
    echo "‚ùå SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω: $KEY_FILE"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á: ssh-keygen -t rsa -b 4096"
    exit 1
fi

echo "üîë –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SSH –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä $SERVER..."
echo ""

# –ß—Ç–µ–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞
PUBLIC_KEY=$(cat "$KEY_FILE")

echo "üìã –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á:"
echo "$PUBLIC_KEY"
echo ""

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
echo "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è $SERVER:"

ssh "$SERVER" "mkdir -p ~/.ssh && echo '$PUBLIC_KEY' >> ~/.ssh/authorized_keys && chmod 700 ~/.ssh && chmod 600 ~/.ssh/authorized_keys && echo '‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!'"

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ SSH –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä!"
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
    ssh -o ConnectTimeout=5 -o BatchMode=yes "$SERVER" "echo '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!'" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–∞—Ä–æ–ª—è!"
    else
        echo "‚ö†Ô∏è  –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–æ–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
        echo "   1. –ö–ª—é—á –ø—Ä–∞–≤–∏–ª—å–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω"
        echo "   2. –ü—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ (700 –¥–ª—è .ssh, 600 –¥–ª—è authorized_keys)"
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞"
    exit 1
fi
